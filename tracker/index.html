<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const BACKEND="https://ptv-gtfs-bus-backend.onrender.com";
const ENABLE_LANDSCAPE_TABLET_LAYOUT=true;

let fleetNumber="";
let inputMode="fleet";

if(ENABLE_LANDSCAPE_TABLET_LAYOUT){
  document.body.classList.add("landscape-trial-enabled");
}

let map,marker,userMarker,pathLine,userLatLng,busLatLng,watchId=null,directionsEnabled=false,currentOperator="";
let deviceHeading=null;
let motionHeading=null;
let compassListener=null;

/* ================= MODE ================= */
function toggleMode(){
  clearFleet();
  const title=document.getElementById("pageTitle");
  const modeToggle=document.getElementById("modeToggle");
  const modeLogo=document.getElementById("modeLogo");
  const vicLabel=document.getElementById("vicLabel");
  const nswLabel=document.getElementById("nswLabel");

  if(inputMode==="fleet"){
    inputMode="rego";
    modeToggle.checked=true;
    modeLogo.src="logos/nsw.png";
    title.innerText="Enter NSW Rego";
    vicLabel.classList.remove("active");
    nswLabel.classList.add("active");
  }else{
    inputMode="fleet";
    modeToggle.checked=false;
    modeLogo.src="logos/vic.png";
    title.innerText="Enter Fleet Number";
    nswLabel.classList.remove("active");
    vicLabel.classList.add("active");
  }
}

function handleModeSwitch(isNsw){
  if((isNsw&&inputMode==="rego")||(!isNsw&&inputMode==="fleet"))return;
  toggleMode();
}

/* ================= KEYPAD ================= */
function addDigit(n){
  if(fleetNumber.length>=8)return;
  fleetNumber+=n;
  document.getElementById("fleetDisplay").innerText=fleetNumber;
}

function backspace(){
  fleetNumber=fleetNumber.slice(0,-1);
  document.getElementById("fleetDisplay").innerText=fleetNumber;
}

function clearFleet(){
  fleetNumber="";
  document.getElementById("fleetDisplay").innerText="";
}

/* ================= FIND BUS ================= */
async function findBus(){
  if(!fleetNumber) return alert("Enter number.");

  /* ===== SECRET FEATURE ===== */
  if(fleetNumber==="0000"){
    await findNearestBus();
    return;
  }

  /* ===== NSW MODE ===== */
  if(inputMode==="rego"){
    const res=await fetch(`${BACKEND}/nsw/${fleetNumber}`);
    const data=await res.json();

    if(data.error) return alert("NSW bus not found.");

    if(data.single){
      showBusOnMap(data.latitude,data.longitude,"nsw",data.status,data.timestamp);
      return;
    }

    if(data.multiple){
      const container=document.getElementById("operatorSection");
      container.innerHTML="";
      container.classList.remove("hidden");

      document.getElementById("keypad").classList.add("hidden");
      document.getElementById("findButton").classList.add("hidden");
      document.getElementById("modeToggleWrap").classList.add("hidden");
      document.getElementById("operatorBackButton").classList.remove("hidden");

      data.options.forEach(rego=>{
        const btn=document.createElement("button");
        btn.innerText=rego;
        btn.onclick=()=>loadNswExact(rego);
        container.appendChild(btn);
      });
    }
    return;
  }

  /* ===== VIC MODE ===== */
  const res=await fetch(`${BACKEND}/operators/${fleetNumber}`);
  const data=await res.json();

  if(data.error) return alert("Fleet not found.");

  if(data.operators.length===1){
    loadBus(fleetNumber,data.operators[0]);
  }else{
    const container=document.getElementById("operatorSection");
    container.innerHTML="";
    container.classList.remove("hidden");

    document.getElementById("keypad").classList.add("hidden");
    document.getElementById("findButton").classList.add("hidden");
    document.getElementById("modeToggleWrap").classList.add("hidden");
    document.getElementById("operatorBackButton").classList.remove("hidden");

    data.operators.forEach(op=>{
      const btn=document.createElement("button");
      btn.innerText=op;
      btn.onclick=()=>loadBus(fleetNumber,op);
      container.appendChild(btn);
    });
  }
}

/* ===== SECRET NEAREST BUS ===== */
async function findNearestBus(){
  if(!navigator.geolocation){
    alert("Geolocation not supported.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async(pos)=>{
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;

    const res=await fetch(`${BACKEND}/nearest?lat=${lat}&lng=${lng}`);
    const data=await res.json();

    if(data.error) return alert("Nearest bus unavailable.");

    showBusOnMap(
      data.latitude,
      data.longitude,
      data.operator||"vic",
      data.status,
      data.timestamp
    );
  },()=>{
    alert("Location permission denied.");
  },{enableHighAccuracy:true});
}

/* ===== LOADERS ===== */
async function loadBus(fleet,operator){
  const res=await fetch(`${BACKEND}/bus/${fleet}/${operator}`);
  const data=await res.json();
  if(data.error)return alert("Bus not active.");
  showBusOnMap(data.latitude,data.longitude,operator,data.status,data.timestamp);
}

async function loadNswExact(rego){
  const res=await fetch(`${BACKEND}/nsw-exact/${rego}`);
  const data=await res.json();
  if(data.error)return alert("NSW bus not found.");
  showBusOnMap(data.latitude,data.longitude,"nsw",data.status,data.timestamp);
}
</script>
