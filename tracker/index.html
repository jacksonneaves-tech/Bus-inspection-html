<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fleet Tracking</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root {
  --bg-dark:#0f172a;
  --card-dark:#1e293b;
  --accent-blue:#2563eb;
  --accent-blue-hover:#1d4ed8;
  --text-light:#f1f5f9;
  --text-muted:#94a3b8;
  --border-soft:rgba(255,255,255,0.08);
}

/* ===== ORIGINAL STYLES (UNCHANGED) ===== */

body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  background:linear-gradient(145deg,#0f172a,#1e293b);
  color:var(--text-light);
}

.header{
  padding:20px;
  background:#0b1220;
  border-bottom:1px solid var(--border-soft);
  text-align:center;
  font-weight:600;
}

.container{padding:20px;}

.card{
  max-width:520px;
  margin:auto;
  background:var(--card-dark);
  padding:30px;
  border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,0.4);
  border:1px solid var(--border-soft);
  min-height:520px;
}

h1{text-align:center;}

.fleet-display{
  text-align:center;
  font-size:28px;
  letter-spacing:4px;
  padding:15px;
  border:1px solid var(--border-soft);
  border-radius:14px;
  margin-bottom:20px;
  min-height:32px;
}

.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}

.keypad button{
  padding:18px;
  font-size:20px;
  border-radius:14px;
  border:none;
  background:#0f172a;
  color:var(--text-light);
  cursor:pointer;
  border:1px solid var(--border-soft);
}

.keypad button:hover{background:var(--accent-blue);}

.find-btn,.back-btn{
  margin-top:15px;
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  background:var(--accent-blue);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.hidden{display:none;}

#map{
  height:420px;
  border-radius:16px;
  margin-bottom:15px;
}

.bus-marker{
  font-size:42px;
  animation:floatBus 2s ease-in-out infinite;
  text-align:center;
}

@keyframes floatBus{
  0%{transform:translateY(0);}
  50%{transform:translateY(-5px);}
  100%{transform:translateY(0);}
}

/* ===== NEW: EASTER EGG OVERLAY ===== */

.nearest-overlay{
  position:fixed;
  inset:0;
  background:linear-gradient(145deg,#0f172a,#1e293b);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:9999;
}

.nearest-overlay.hidden{
  display:none;
}

.nearest-title{
  font-size:22px;
  font-weight:600;
  margin-bottom:30px;
  text-align:center;
}

.emoji-rain{
  position:relative;
  width:100%;
  height:200px;
  overflow:hidden;
}

.floating-emoji{
  position:absolute;
  font-size:32px;
  animation:floatUp 3s linear infinite;
}

@keyframes floatUp{
  0%{transform:translateY(150px) rotate(0deg);opacity:0;}
  20%{opacity:1;}
  100%{transform:translateY(-200px) rotate(360deg);opacity:0;}
}
</style>
</head>

<body>

<div class="header">FLEET TRACKING</div>

<div class="container">
<div class="card">

<!-- PAGE 1 -->
<div id="page1">
<h1>Enter Fleet Number</h1>
<div class="fleet-display" id="fleetDisplay"></div>

<div class="keypad">
<button onclick="addDigit(1)">1</button>
<button onclick="addDigit(2)">2</button>
<button onclick="addDigit(3)">3</button>
<button onclick="addDigit(4)">4</button>
<button onclick="addDigit(5)">5</button>
<button onclick="addDigit(6)">6</button>
<button onclick="addDigit(7)">7</button>
<button onclick="addDigit(8)">8</button>
<button onclick="addDigit(9)">9</button>
<button onclick="clearFleet()">C</button>
<button onclick="addDigit(0)">0</button>
<button onclick="backspace()">‚å´</button>
</div>

<button class="find-btn" onclick="findBus()">Find Bus</button>
</div>

<!-- PAGE 2 -->
<div id="page2" class="hidden">
<div id="busStatus" style="text-align:center;font-weight:600;margin-bottom:10px;"></div>
<div id="map"></div>
<button class="find-btn" onclick="goBack()">Find Another Bus</button>
</div>

</div>
</div>

<!-- NEW OVERLAY -->
<div id="nearestOverlay" class="nearest-overlay hidden">
<div class="nearest-title">üîé Hunting the Nearest Bus...</div>
<div class="emoji-rain" id="emojiRain"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const BACKEND="https://ptv-gtfs-bus-backend.onrender.com";

let fleetNumber="";
let map;

/* ===== KEYPAD (UNCHANGED) ===== */
function addDigit(n){
  if(fleetNumber.length>=8)return;
  fleetNumber+=n;
  document.getElementById("fleetDisplay").innerText=fleetNumber;
}
function backspace(){
  fleetNumber=fleetNumber.slice(0,-1);
  document.getElementById("fleetDisplay").innerText=fleetNumber;
}
function clearFleet(){
  fleetNumber="";
  document.getElementById("fleetDisplay").innerText="";
}

/* ===== FIND BUS (ONLY ADDITION: 0000 CHECK) ===== */
async function findBus(){
  if(!fleetNumber)return alert("Enter number.");

  if(fleetNumber==="0000"){
    await findNearestBus();
    return;
  }

  const res=await fetch(`${BACKEND}/operators/${fleetNumber}`);
  const data=await res.json();
  if(data.error)return alert("Fleet not found.");

  const res2=await fetch(`${BACKEND}/bus/${fleetNumber}/${data.operators[0]}`);
  const data2=await res2.json();
  if(data2.error)return alert("Bus not active.");

  showBusOnMap(data2.latitude,data2.longitude,data2.status,data2.rego,"VIC");
}

/* ===== NEW NEAREST BUS FUNCTION ===== */
async function findNearestBus(){
  showNearestOverlay();

  navigator.geolocation.getCurrentPosition(async(pos)=>{
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;

    const res=await fetch(`${BACKEND}/nearest?lat=${lat}&lng=${lng}`);
    const data=await res.json();

    hideNearestOverlay();

    showBusOnMap(data.latitude,data.longitude,data.status,data.rego,data.state);

  },()=>{
    hideNearestOverlay();
    alert("Location denied");
  },{enableHighAccuracy:true});
}

/* ===== OVERLAY FUNCTIONS ===== */
function showNearestOverlay(){
  const overlay=document.getElementById("nearestOverlay");
  const rain=document.getElementById("emojiRain");
  overlay.classList.remove("hidden");
  rain.innerHTML="";
  const emojis=["üöå","üê£","ü•ö","üöç","üê∞"];
  for(let i=0;i<25;i++){
    const span=document.createElement("span");
    span.className="floating-emoji";
    span.innerText=emojis[Math.floor(Math.random()*emojis.length)];
    span.style.left=Math.random()*100+"%";
    span.style.animationDelay=Math.random()*3+"s";
    rain.appendChild(span);
  }
}
function hideNearestOverlay(){
  document.getElementById("nearestOverlay").classList.add("hidden");
}

/* ===== MAP ===== */
function showBusOnMap(lat,lng,status,identifier,state){
  document.getElementById("page1").classList.add("hidden");
  document.getElementById("page2").classList.remove("hidden");

  document.getElementById("busStatus").innerText=
    `Nearest Bus ‚Äì ${state} ${identifier}`;

  if(map)map.remove();
  map=L.map("map").setView([lat,lng],16);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const icon=L.divIcon({
    html:`<div class="bus-marker">üöå</div>`,
    className:"",
    iconSize:[60,60],
    iconAnchor:[30,30]
  });

  L.marker([lat,lng],{icon}).addTo(map);
}

function goBack(){
  document.getElementById("page2").classList.add("hidden");
  document.getElementById("page1").classList.remove("hidden");
  clearFleet();
}
</script>

</body>
</html>
