<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>PTV Fleet Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>

<style>
body {
  margin:0;
  font-family: Arial;
  text-align:center;
}

#searchPage {
  padding-top:100px;
}

input {
  font-size:22px;
  padding:10px;
  width:140px;
  text-align:center;
}

button {
  font-size:18px;
  padding:10px 20px;
  margin-top:10px;
  background:#007bff;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

#mapPage {
  display:none;
}

#map {
  height:70vh;
}

#info {
  padding:15px;
}

.status-live {
  color:green;
  font-weight:bold;
}

.status-offline {
  color:red;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="searchPage">
  <h2>Enter Fleet Number</h2>
  <input id="fleetInput" maxlength="4" />
  <br>
  <button onclick="findOperators()">Search</button>
  <div id="operatorSelect"></div>
</div>

<div id="mapPage">
  <div id="info"></div>
  <div id="map"></div>
  <button onclick="goBack()">Find Another Bus</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const BACKEND = "https://ptv-gtfs-bus-backend.onrender.com";

let map;
let marker;
let currentFleet;
let currentOperator;

async function findOperators() {
  const fleet = document.getElementById("fleetInput").value.trim();
  if (!fleet) return;

  const res = await fetch(`${BACKEND}/operators/${fleet}`);
  const data = await res.json();

  if (data.error) {
    alert("Fleet number not found.");
    return;
  }

  currentFleet = fleet;

  if (data.operators.length === 1) {
    loadBus(data.operators[0]);
  } else {
    const div = document.getElementById("operatorSelect");
    div.innerHTML = "<h3>Select Operator</h3>";

    data.operators.forEach(op => {
      const btn = document.createElement("button");
      btn.innerText = op;
      btn.onclick = () => loadBus(op);
      div.appendChild(document.createElement("br"));
      div.appendChild(btn);
    });
  }
}

async function loadBus(operator) {
  currentOperator = operator;

  document.getElementById("searchPage").style.display = "none";
  document.getElementById("mapPage").style.display = "block";

  if (!map) {
    map = L.map("map").setView([-37.81,144.96], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }

  updateBus();
  setInterval(updateBus, 10000);
}

async function updateBus() {
  const res = await fetch(`${BACKEND}/bus/${currentFleet}/${currentOperator}`);
  const data = await res.json();

  if (data.error) {
    alert("Bus not active.");
    goBack();
    return;
  }

  const latlng = [data.latitude, data.longitude];

  if (!marker) {
    marker = L.marker(latlng).addTo(map);
  } else {
    marker.setLatLng(latlng);
  }

  map.setView(latlng);

  const date = new Date(data.timestamp * 1000);

  document.getElementById("info").innerHTML = `
    <h3>Fleet ${data.fleet} (${data.operator})</h3>
    Route: ${data.routeId}<br>
    Status: <span class="${data.live ? 'status-live' : 'status-offline'}">
      ${data.live ? 'LIVE' : 'OFFLINE'}
    </span><br>
    Last Update: ${date.toLocaleTimeString()}
  `;
}

function goBack() {
  location.reload();
}
</script>

</body>
</html>
